#coding=utf-8
import oss2
import uuid
import json
import time
import threading
import sys
from aliyunsdkgreen.request.v20180509 import UploadCredentialsRequest
from . import UploadCredentials
from . import HttpContentHelper

lock = lock=threading.Lock()
class ClientUploader:

    def __init__(self, clt, filType, internal):
        self._clt = clt
        self._credentials = None
        self._header = {}
        self._fileType = filType
        if True != internal:
            self._internal = False
        else:
            self._internal = True

# 从获取上传凭证
    def _getCredential(self):
        if self._credentials == None or self._credentials.get_ExpiredTime() < time.time()*1000:
            lock.acquire()
            try:
                if self._credentials == None or self._credentials.get_ExpiredTime() < time.time()*1000:
                   self._credentials = self._getCredentialsFromServer()
            finally:
                lock.release()
        return self._credentials

# 从服务器端获取上传凭证
    def _getCredentialsFromServer(self):
        request = UploadCredentialsRequest.UploadCredentialsRequest()
        request.set_accept_format('JSON')
        # python2 和python3 这里调用设置不一样
        if sys.version_info[0] == 2:
            for (key, value) in self._header.iteritems():
                request.add_header(key, value)
        if sys.version_info[0] == 3:
            for (key, value) in self._header.items():
                request.add_header(key, value)
        request.set_content(HttpContentHelper.toValue({}))
        response = self._clt.do_action(request)
        result = json.loads(response)
        if 200 == result['code']:
            data = result['data']
            return UploadCredentials.UploadCredentials(data['accessKeyId'],data['accessKeySecret'], data['securityToken'],data['expiredTime'],data['ossEndpoint'], data['ossInternalEndpoint'], data['uploadBucket'],data['uploadFolder'])
        raise RuntimeError('get upload credential from server fail. requestId:' + str(result['requestId']) + ', code:' + str(result['code']))

# 上传本地文件
    def uploadFile(self, yourLocalFilePath):
        credentials = self._getCredential();
        if credentials == None:
            raise RuntimeError('can not get upload credentials')
        auth = oss2.StsAuth(self._credentials.get_AccessKeyId(), self._credentials.get_AccessKeySecret(), self._credentials.get_SecurityToken())
        bucket = oss2.Bucket(auth, self.getEndpoint(), self._credentials.get_UploadBucket())
        objectKey = self._credentials.get_UploadFolder() + '/' + self._fileType + '/' + str(uuid.uuid1()) + '.jpg'
        bucket.put_object_from_file(objectKey , yourLocalFilePath)
        return 'oss://' + self._credentials.get_UploadBucket() + "/" + objectKey

# 上传Bytes
    def uploadBytes(self, bytes):
        credentials = self._getCredential();
        if credentials == None:
            raise RuntimeError('can not get upload credentials')
        auth = oss2.StsAuth(self._credentials.get_AccessKeyId(), self._credentials.get_AccessKeySecret(),
                            self._credentials.get_SecurityToken())
        bucket = oss2.Bucket(auth, self.getEndpoint(), self._credentials.get_UploadBucket())
        objectKey = self._credentials.get_UploadFolder() + '/' + self._fileType + '/' + str(uuid.uuid1()) + '.jpg'
        bucket.put_object(objectKey, bytes)
        return 'oss://' + self._credentials.get_UploadBucket() + '/' + objectKey

    def add_header(self, k, v):
        self._header[k] = v

    def getEndpoint(self):
        endpoint = self._credentials.get_OssEndpoint();
        if True == self._internal:
            endpoint = self._credentials.get_OssInternalEndpoint()
        return endpoint

def getImageClientUploader(clt, internal=False):
    return ClientUploader(clt, "images", internal);

def getVideoClientUploader(clt, internal=False):
    return ClientUploader(clt, "videos", internal);

def getVoiceClientUploader(clt, internal=False):
    return ClientUploader(clt, "voices", internal);

def getFileClientploader(clt, internal=False):
    return ClientUploader(clt, "files", internal);


