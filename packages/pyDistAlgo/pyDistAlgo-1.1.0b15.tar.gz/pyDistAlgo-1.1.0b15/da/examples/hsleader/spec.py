# -*- generated by 1.0.14 -*-
import da
PatternExpr_192 = da.pat.TuplePattern([da.pat.ConstantPattern('Out'), da.pat.SelfPattern(), da.pat.FreePattern('d')])
PatternExpr_232 = da.pat.TuplePattern([da.pat.ConstantPattern('Leader'), da.pat.FreePattern('leader')])
PatternExpr_260 = da.pat.TuplePattern([da.pat.ConstantPattern('In'), da.pat.SelfPattern()])
PatternExpr_267 = da.pat.BoundPattern('_BoundPattern268_')
PatternExpr_283 = da.pat.TuplePattern([da.pat.ConstantPattern('In'), da.pat.SelfPattern()])
PatternExpr_290 = da.pat.BoundPattern('_BoundPattern291_')
PatternExpr_312 = da.pat.TuplePattern([da.pat.ConstantPattern('Out'), da.pat.FreePattern('v'), da.pat.FreePattern('d')])
PatternExpr_321 = da.pat.FreePattern('source')
PatternExpr_358 = da.pat.TuplePattern([da.pat.ConstantPattern('In'), da.pat.FreePattern('v')])
PatternExpr_365 = da.pat.FreePattern('source')
PatternExpr_385 = da.pat.TuplePattern([da.pat.ConstantPattern('Leader'), da.pat.FreePattern('leader')])
PatternExpr_392 = da.pat.FreePattern('source')
PatternExpr_269 = da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.FreePattern(None), da.pat.BoundPattern('_BoundPattern275_')]), da.pat.TuplePattern([da.pat.ConstantPattern('In'), da.pat.SelfPattern()])])
PatternExpr_292 = da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.FreePattern(None), da.pat.BoundPattern('_BoundPattern298_')]), da.pat.TuplePattern([da.pat.ConstantPattern('In'), da.pat.SelfPattern()])])
_config_object = {}
import sys
import random

class P(da.DistProcess):

    def __init__(self, procimpl, props):
        super().__init__(procimpl, props)
        self._PReceivedEvent_0 = []
        self._PReceivedEvent_1 = []
        self._PReceivedEvent_2 = []
        self._PReceivedEvent_3 = []
        self._events.extend([da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_0', PatternExpr_192, sources=None, destinations=None, timestamps=None, record_history=True, handlers=[]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_1', PatternExpr_232, sources=None, destinations=None, timestamps=None, record_history=True, handlers=[]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_2', PatternExpr_260, sources=[PatternExpr_267], destinations=None, timestamps=None, record_history=True, handlers=[]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_3', PatternExpr_283, sources=[PatternExpr_290], destinations=None, timestamps=None, record_history=True, handlers=[]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_4', PatternExpr_312, sources=[PatternExpr_321], destinations=None, timestamps=None, record_history=None, handlers=[self._P_handler_311]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_5', PatternExpr_358, sources=[PatternExpr_365], destinations=None, timestamps=None, record_history=None, handlers=[self._P_handler_357]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_6', PatternExpr_385, sources=[PatternExpr_392], destinations=None, timestamps=None, record_history=None, handlers=[self._P_handler_384])])

    def setup(self, left, right, **rest_488):
        super().setup(left=left, right=right, **rest_488)
        self._state.left = left
        self._state.right = right
        pass

    def run(self):
        distance = 1
        while True:
            self.send(('Out', self._id, distance), to={self._state.left, self._state.right})
            super()._label('_st_label_189', block=False)
            d = None

            def ExistentialOpExpr_190():
                nonlocal d
                for (_, _, (_ConstantPattern209_, _ConstantPattern211_, d)) in self._PReceivedEvent_0:
                    if (_ConstantPattern209_ == 'Out'):
                        if (_ConstantPattern211_ == self._id):
                            if True:
                                return True
                return False
            leader = None

            def ExistentialOpExpr_230():
                nonlocal leader
                for (_, _, (_ConstantPattern247_, leader)) in self._PReceivedEvent_1:
                    if (_ConstantPattern247_ == 'Leader'):
                        if True:
                            return True
                return False
            _st_label_189 = 0
            while (_st_label_189 == 0):
                _st_label_189 += 1
                if ExistentialOpExpr_190():
                    self.output(('I am leader at distance %d!' % d))
                    self.send(('Leader', self._id), to={self._state.left, self._state.right})
                    break
                    _st_label_189 += 1
                elif ExistentialOpExpr_230():
                    self.output('Leader is', leader)
                    break
                    _st_label_189 += 1
                elif (PatternExpr_269.match_iter(self._PReceivedEvent_2, _BoundPattern275_=self._state.left, SELF_ID=self._id) and PatternExpr_292.match_iter(self._PReceivedEvent_3, _BoundPattern298_=self._state.right, SELF_ID=self._id)):
                    distance *= 2
                    for attr in dir(self):
                        if (attr.find('ReceivedEvent_') != (- 1)):
                            getattr(self, attr).clear()
                    _st_label_189 += 1
                else:
                    super()._label('_st_label_189', block=True)
                    _st_label_189 -= 1
            else:
                if (_st_label_189 != 2):
                    continue
            if (_st_label_189 != 2):
                break

    def _P_handler_311(self, v, d, source):
        if (v > self._id):
            if (d > 1):
                self.send(('Out', v, (d - 1)), to=(self._state.right if (source == self._state.left) else self._state.left))
            elif (d == 1):
                self.send(('In', v), to=source)
    _P_handler_311._labels = None
    _P_handler_311._notlabels = None

    def _P_handler_357(self, v, source):
        if (v > self._id):
            self.send(('In', v), to=(self._state.right if (source == self._state.left) else self._state.left))
    _P_handler_357._labels = None
    _P_handler_357._notlabels = None

    def _P_handler_384(self, leader, source):
        self.send(('Leader', leader), to=(self._state.right if (source == self._state.left) else self._state.left))
    _P_handler_384._labels = None
    _P_handler_384._notlabels = None

class Node_(da.NodeProcess):

    def __init__(self, procimpl, props):
        super().__init__(procimpl, props)
        self._events.extend([])
    _config_object = {'channel': 'fifo'}

    def run(self):
        n = (int(sys.argv[1]) if (len(sys.argv) > 1) else 10)
        topology = list(self.new(P, num=n))
        random.shuffle(topology)
        for (i, p) in enumerate(topology):
            if (i == (len(topology) - 1)):
                self._setup({p}, (topology[(i - 1)], topology[0]))
            else:
                self._setup({p}, (topology[(i - 1)], topology[(i + 1)]))
        self._start(topology)
