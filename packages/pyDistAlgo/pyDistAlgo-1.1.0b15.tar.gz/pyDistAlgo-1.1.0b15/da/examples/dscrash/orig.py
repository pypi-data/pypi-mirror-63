# -*- generated by 1.0.14 -*-
import da
PatternExpr_259 = da.pat.TuplePattern([da.pat.ConstantPattern('done')])
PatternExpr_264 = da.pat.BoundPattern('_BoundPattern265_')
PatternExpr_279 = da.pat.TuplePattern([da.pat.ConstantPattern('Value'), da.pat.FreePattern('v')])
PatternExpr_266 = da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.TuplePattern([da.pat.FreePattern(None), da.pat.FreePattern(None), da.pat.BoundPattern('_BoundPattern272_')]), da.pat.TuplePattern([da.pat.ConstantPattern('done')])])
_config_object = {'channel': 'Reliable', 'handling': 'one'}
import sys

class P(da.DistProcess):

    def __init__(self, procimpl, props):
        super().__init__(procimpl, props)
        self._PReceivedEvent_0 = []
        self._events.extend([da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_0', PatternExpr_259, sources=[PatternExpr_264], destinations=None, timestamps=None, record_history=True, handlers=[]), da.pat.EventPattern(da.pat.ReceivedEvent, '_PReceivedEvent_1', PatternExpr_279, sources=None, destinations=None, timestamps=None, record_history=None, handlers=[self._P_handler_278])])

    def setup(self, ps, v, maxfail, **rest_364):
        super().setup(ps=ps, v=v, maxfail=maxfail, **rest_364)
        self._state.ps = ps
        self._state.v = v
        self._state.maxfail = maxfail
        self._state.x = (- 1)
        self._state.V = {self._state.v: False}
        self._state.receiveflag = False

    def run(self):
        super()._label('start', block=False)
        for i in range(self._state.maxfail):
            super()._label('one_round', block=False)
            for k in self._state.V:
                if (not self._state.V[k]):
                    self.send(('Value', k), to=self._state.ps)
                    self._state.V[k] = True
            super()._label('_st_label_223', block=False)
            _st_label_223 = 0
            while (_st_label_223 == 0):
                _st_label_223 += 1
                if self._state.receiveflag:
                    _st_label_223 += 1
                else:
                    super()._label('_st_label_223', block=True)
                    _st_label_223 -= 1
            else:
                if (_st_label_223 != 2):
                    continue
            if (_st_label_223 != 2):
                break
            self._state.receiveflag = False
        super()._label('end', block=False)
        self.send(('done',), to=self._state.ps)
        self._state.x = max([self._state.v for self._state.v in self._state.V if self._state.V[self._state.v]])
        self.output(('x = %r' % self._state.x))
        super()._label('_st_label_250', block=False)
        p = None

        def UniversalOpExpr_251():
            nonlocal p
            for p in self._state.ps:
                if (not PatternExpr_266.match_iter(self._PReceivedEvent_0, _BoundPattern272_=p, SELF_ID=self._id)):
                    return False
            return True
        _st_label_250 = 0
        while (_st_label_250 == 0):
            _st_label_250 += 1
            if UniversalOpExpr_251():
                _st_label_250 += 1
            else:
                super()._label('_st_label_250', block=True)
                _st_label_250 -= 1

    def _P_handler_278(self, v):
        self._state.receiveflag = True
        if (not (v in self._state.V)):
            self._state.V[v] = False
    _P_handler_278._labels = None
    _P_handler_278._notlabels = None

class Node_(da.NodeProcess):

    def __init__(self, procimpl, props):
        super().__init__(procimpl, props)
        self._events.extend([])

    def run(self):
        n = (int(sys.argv[1]) if (len(sys.argv) > 1) else 10)
        f = (int(sys.argv[2]) if (len(sys.argv) > 2) else 50)
        ps = self.new(P, num=n)
        for (i, p) in enumerate(list(ps)):
            self._setup({p}, (ps, i, f))
        self._start(ps)
