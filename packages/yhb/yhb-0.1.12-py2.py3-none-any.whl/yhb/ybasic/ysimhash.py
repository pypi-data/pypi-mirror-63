# encoding:utf-8
import re
import jieba
import jieba.analyse
import redis
import zhon.hanzi
from simhash import Simhash

stopwords = '''随后
hereby
哪个
由于
趁
譬喻
如若
起来
以免
噢
公然
would
8
之所以
yourselves
对待
??Զ??
尽量
猛然间
［④ｃ］
进去
不要
无论
you
大凡
possible
four
尔后
：
具体来说
扑通
宁
viz
所有
藉以
we
whence
ʧȥ
无宁
大都
除此之外
１．
充分
吧哒
greetings
余外
??ǰ
unfortunately
归根到底
正值
］∧′＝［
截至
话
regarding
whole
叫
ʲô?
particularly
省得
各
Ը?
趁早
屡次三番
怎样
忽然
几度
你
靠
followed
各自
何尝
һʱ
［②ｅ］
即将
??ȫ
正如
先生
一
?ǰ
maybe
这么点儿
切不可
除开
＋ξ
啷当
怪不得
切莫
whether
?Ļ?
ͬ?
一何
ｎｇ昉
日复一日
˵˵
比照
等
有及
格外
据此
regardless
neither
relatively
本地
?ʵ
直到
比如
exactly
多
something
就是说
［③］
绝对
we're
莫不
啊
如今
should
forth
这么样
嘛
开始
［③⑩］
昂然
较为
ɶ
see
在下
再者说
ԭ??
μ
亲手
５：０
大多
?ɼ?
种
∈［
this
纵令
һ???
咦
尔等
仍然
简直
长此下去
զ
而外
keep
for
needs
每当
呃
总的来说
Ҫô
不日
??Ӧ
按期
依据
?ȥ
阿
quite
是的
looking
从
@
正巧
乘机
??˿ɼ?
那些
c'mon
］［
hence
嘎嘎
willing
along
别处
较之
֮
还有
②
一方面
ͬ
unless
】
出于
极大
Ϊ?
倘然
风雨无阻
假使
［⑤ｆ］
have
那末
不怕
借此
［②ｇ］
noone
每时每刻
多多少少
＇
向
当即
经过
常言说得好
绝顶
＝（
咱们
再者
第
＝｛
起
despite
沿着
赶快
％
second
′∈
只怕
howbeit
咋
大举
usually
对比
用
不能不
每每
???˵
ž??
ר?
除非
inc
岂但
must
从早到晚
加上
什么
除外
after
偶尔
used
＜φ
儿
几时
哪边
今
到目前为止
says
across
就地
冒
＆
overall
以为
过于
理该
呸
c's
自各儿
即是说
??ȥ
here's
［①②］
Ϊʲô
ս??
?˼?
其后
果真
互相
嘎登
;
极了
least
｝＞
?ͼ
⑨
奋勇
clearly
ȷ??
［⑩］
再其次
匆匆
二来
此处
有的是
say
well
？
全然
we'd
宁可
从轻
据实
thereafter
常言说
seeming
仍旧
０：２
provides
ĳ??
毫不
Ӧ?
不得
gives
?Щ
Ҫ
忽地
tends
getting
]
ZT
恰如
『
云尔
not
全体
她们
ｅ］
＜
??????˵
但是
立马
allows
乃
tell
兮
［③ａ］
rd
凭
himself
definitely
或则
since
<
以及
切切
为什么
处处
以来
看
ֱ??
在
edu
first
腾
不论
等等
顷刻间
替
起头
这些
从今以后
倒是
whom
如期
迟早
???֮
个
起首
thence
known
?˴?
?Ϊ
那时
不由得
趁着
只是
三天两头
［①］
around
一直
俺
any
let's
name
［②①］
并无
千万千万
went
极力
从宽
?ﵽ
般的
В
怎么样
例如
甚而
nobody
their
welcome
looks
啐
??ѽ
?Ը
为此
砰
呵
者
假若
另外
sometimes
不若
挨着
若果
则
来
⑥
并肩
eg
交口
been
随
慢说
［］
comes
从中
不怎么
虽
尽管
甚且
'
Ŀǰ
former
》
要不
比
您们
很少
already
beforehand
course
长话短说
behind
并没有
截然
基于
方能
本着
人人
??ϰ
嘎
appropriate
既是
［①⑤］
③
过
他们
某
wonder
呵呵
立刻
besides
吱
继之
哎
总的说来
屡次
zz
ֻ?
help
哼
这般
趁势
contains
川流不息
作为
反之亦然
sub
连日来
ƾ??
－β
……
④
吗
尔
［①ｇ］
毫无保留地
您
来看
以上
另
呀
specified
差一点
并没
某某
比方
［③Ｆ］
less
your
如其
人
so
couldn't
nd
）、
切勿
has
总而言之
自后
不仅
wants
necessary
得天独厚
through
?õ?
following
哎呀
everywhere
可好
last
除此而外
到处
apart
请勿
自己
eight
当头
从而
居然
再次
次第
had
［④ａ］
很多
the
如常
则甚
所在
更为
every
?ô?
联袂
֮?
available
during
seen
乃至
默然
像
一旦
嘿嘿
really
届时
.日
以至于
she
２．３％
它
从严
话说
豁然
就算
several
在于
?ȫ
perhaps
除了
倒不如
℃
不外
这儿
从未
everything
?֮
那
即刻
不然的话
起初
［①Ｃ］
i've
oh
whatever
那会儿
大抵
咱
何况
庶几
okay
故意
嗯
打从
?ʱ
via
over
?˼
；
自身
five
再有
尽心尽力
连声
later
׼??
这时
?Χ
看上去
再说
不如
欤
虽然
［⑥］
反之
next
“
therein
成年累月
何苦
多年前
）÷（１－
一样
you've
除此
受到
ｆ］
my
Ҳ
隔夜
being
分头
Ī?
［①③］
?Ҫ
一转眼
不惟
whenever
类如
gotten
??չ
竟而
元／吨
given
大
趁便
he
矣
不过
以至
beyond
再则
拿
until
×××
Ż
two
［①⑨］
依
不是
也就是说
凝神
becoming
beside
before
com
喂
若
ignored
trying
难怪
what
不尽
Ҫ???
后者
hers
ʲô
??Ω
如同
并排
self
［②］
譬如
~~~~
只消
??ֻ
Ҫ??
略微
咳
简而言之
$
非常
qv
加之
believe
因着
amongst
［②③］
”
决不
et
??ʼ
Ҳ?
假如
别的
once
......
ours
牢牢
按照
someone
路经
刚好
accordingly
whither
formerly
之后
ie
its
un
same
??ֹ
ȴ??
＋＋
怎奈
’‘
Ϊ??
won't
比及
这会儿
［⑤ｂ］
concerning
不同
还
＝☆
比如说
said
来得及
哪些
啊呀
独自
think
?ḻ
即
吧
hopefully
?????
co
上下
这个
non
...
or
碰巧
是
何须
→
"
随着
哪
indicates
anywhere
并且
正是
与否
不尽然
third
Lex
［②Ｂ］
::
较
第二
changes
［③ｇ］
各种
彼
将才
不问
得
借以
如果
恰恰
ask
zero
漫说
far
何时
二话没说
［②⑧］
眨眼
among
诚然
大张旗鼓
becomes
＝″
associated
together
老是
也罢
不然
个人
两者
亲口
可以
没奈何
??ӭ
sensible
既往
呜呼
通过
孰料
具体地说
喽
之
get
ok
或多或少
aside
按理
将
，也
若非
?Ч
且
不光
才
咧
必将
wish
goes
??Ȼ
but
跟
三番五次
ÿ?
何处
ͻȻ
多亏
--
described
另一方面
哟
best
们
did
完了
尽可能
这么些
nothing
?ο?
够瞧的
您是
难说
的
《
·
别说
从此以后
whose
暗自
临
exp
别是
看起来
ĳЩ
即或
瑟瑟
might
望
somewhat
one
共总
有的
从古到今
以故
所
uses
哪怕
上
on
那边
saw
要不然
那里
=
顿时
来自
??ʹ
恰好
һ??
?Ӧ
—
多年来
1
①
纯粹
倘若
我
但愿
反过来
啦
就要
up
高低
人家
当庭
即便
哪里
normally
进而
敞开儿
鄙人
inasmuch
using
尽快
而言
［①Ｅ］
嘻
不再
犹且
_
其他
within
或是
之一
当下
different
不可抗拒
及至
若是
truly
趁机
可见
说
毫无例外
不大
哪年
待
既然
indicated
)
［②⑤］
./
有时
便于
设若
一切
֮??
来不及
〔
除此以外
甚至于
──
据说
an
但
更加
这边
的确
鉴于
某个
like
ʮ??
Ӧ??
?ʴ?
个别
如何
已
如上
对于
0
不料
brief
倍感
further
难道说
而且
不巧
毫无
有关
ȫ??
thanks
sorry
不得不
权时
打
前此
不拘
么
－［＊］－
可能
anybody
起先
away
toward
而已
大不了
能
日见
specifying
һ?
?˵
不
陡然
如
herself
ａ］
尽心竭力
具体说来
看来
need
据悉
此
以便
us
Ｒ．Ｌ．
、
wherever
?С
then
according
corresponding
even
yourself
，
连
与
几番
边
会
ת??
凡
to
他是
从小
充其极
please
啊哟
thoroughly
??ϵ
皆可
出来
到了儿
unto
按时
如前所述
各位
就此
?̶?
尽
awfully
?ͬ
矣哉
能否
哪儿
拦腰
所幸
causes
consequently
ǰ?
着呢
有
对方
多么
大大
that
关于
来着
9
namely
many
连袂
一般
onto
let
｝
连日
偶而
亦
嗳
喔唷
这一来
became
于是乎
］
yes
唉
under
时候
尔尔
Ϊ
ʱ??
当
介于
containing
些
vs
other
happens
不了
shouldn't
没有
随时
若夫
固然
:
few
何止
临到
人们
不能
间或
moreover
伙同
当场
just
几乎
趁热
有些
果然
何必
six
too
从不
6
whereupon
.数
才能
猛然
didn't
how
无
不时
万一
［②ｄ］
/
#
数/
巴巴
全年
不至于
以
hadn't
ΰ??
莫非
出去
th
得起
down
挨个
朝着
?
［⑤ｅ］
way
ex
接连不断
contain
的话
按说
hereafter
㈧
a's
?Ȼ
［＊］
根据
,
说来
勃然
不管
策略地
基本
成心
哗
［③①］
indeed
［④ｅ］
何
尚且
〕〔
＋
迫于
乎
长期以来
ͬһ
we've
who's
当口儿
率然
轰然
不定
֨
越是
反倒
֪??
女士
传说
some
whoever
3
certainly
顷刻之间
当地
of
——
把
纵
Ҳ??
即如
下
岂非
据我所知
7
就是
纵然
并
wouldn't
倘
什么样
绝不
presumably
Ａ
动不动
只要
?ô
［①ｈ］
inward
很
these
另一个
appreciate
自打
ＺＸＦＩＴＬ
』
?ǵ?
因
ѽ
－－
seeing
．
到头来
马上
wasn't
反倒是
ͨ??
绝非
故而
??û?
甚么
respectively
》），
比起
⑩
更进一步
当儿
极为
各式
以期
归
?ȵ?
某些
［⑧］
非独
年复一年
actually
因了
处在
亲自
其
存心
cannot
unlikely
顺着
towards
其实
always
want
2
单纯
seven
如次
as
另悉
毕竟
不亦乐乎
如下
into
there
不下
gone
-
谁料
任凭
诸如
×
呕
ע?
??ʱ
own
whereby
ÿ??
许多
new
不起
［①①］
now
因而
anything
Ѹ?
默默地
哎哟
庶乎
平素
［②ａ］
而况
sup
???
嗡
anyway
without
全力
大致
且说
［②ｈ］
ʹ?
ought
甚至
她是
there's
done
近年来
whereafter
都
ÿ
近几年来
该
不可开交
【
i'd
［④ｄ］
从此
反过来说
故
背地里
û?
可是
呼哧
借
知道
throughout
致
只限
差不多
不常
焉
冲
［⑤ｄ］
novel
yet
）
光是
凑巧
这里
犹自
use
我是
them
doing
ֻҪ
呗
何以
become
几经
isn't
与此同时
tries
乘势
?˽?
ĳ
为着
同
asking
liked
＃
又
sent
［①Ａ］
大家
＝［
［－
while
they'll
nine
不知不觉
而又
［①⑥］
他
恰逢
别人
thanx
一些
不限
将近
于
they've
为止
待到
˭
֮һ
换言之
此时
zt
near
??֮
自家
+
必定
而是
八成
all
↑
继后
看样子
Ψ
倒不如说
⑧
不对
him
only
cant
莫如
?ó?
除去
哇
һƬ
Խ?
那么些
基本上
何妨
去
非得
try
Δ
［①ｅ］
˳
不已
使得
Ҫ?
plus
?涨
沿
莫若
lest
本
从来
from
useful
［②ｃ］
因此
etc
来讲
每逢
何乐而不为
暗中
probably
恐怕
顺
甭
none
［④］
somehow
如是
屡屡
nowhere
［③ｄ］
大概
略为
及其
he's
傥然
乘虚
当真
其二
设或
again
secondly
累次
这
～
穷年累月
һֱ
＞λ
more
saying
ltd
soon
即使
▲
由此可见
挨门逐户
综上所述
selves
再
这次
mainly
从速
anyways
倘或
即若
aren't
遵循
前后
抑或
给
既
多多
不少
either
ʵ??
仍
yours
［③ｅ］
首先
简言之
愤然
要
不仅仅
out
with
［①ｄ］
［②
沙沙
thus
sometime
Ӵ
彼此
""
不曾
内
着
［①⑦］
大面儿上
itself
??Χ
Ⅲ
inner
距
毋宁
almost
against
＞
到头
累年
?ʶ
就
决非
they're
其它
相对而言
加以
同时
如上所述
likely
〕
??Ӵ
赶早不赶晚
we'll
?ٽ?
此间
［①Ｄ］
particular
老老实实
③］
嗡嗡
herein
＝
与其
好在
从新
????
本身
巴
怎
＿
连同
?ȡ
不得了
往
哼唷
不只
和
而后
theirs
because
起见
归根结底
everybody
seriously
紧接着
日渐
?ƾ
反手
ones
［②ｉ］
go
略加
一来
尽如人意
little
之类
come
most
ð
为了
不成
但凡
甚或
much
。
哈
［⑨］
或者
乘隙
偏偏
???仰˵
?ȷ
然则
specify
不择手段
ourselves
从优
你是
赶
though
乃至于
上来
be
［⑤ａ］
敢情
嘘
t's
因为
以致
ain't
连连
old
本人
多多益善
it'll
反之则
ô
//
似的
insofar
不比
ǰ??
不外乎
［②②］
除
怎么办
weren't
归齐
孰知
latter
始而
three
三番两次
单单
理应
.
不胜
挨次
it's
thereupon
when
［①Ｂ］
never
ZZ
极度
myself
which
！
哈哈
ȫ?
１２％
莫不然
［①ｏ］
can't
管
［②④
nearly
从头
尽管如此
′｜
一.
恰似
唯有
旁人
γ
如此
况且
任
呢
曾
这么
非徒
缕缕
indicate
小
还要
这就是说
everyone
［③ｃ］
they'd
」
理当
传闻
惟其
谁人
■
进来
*
⑤
ǿ??
方才
且不说
经
当着
?ôЩ
twice
哦
宁愿
多次
结果
ＬＩ
亲眼
what's
开外
fifth
于是
各个
那个
较比
anyone
还是
can
otherwise
不得已
else
who
隔日
急匆匆
instead
whereas
日臻
lately
二话不说
keeps
Ȼ?
will
不免
}
value
全身心
好
一则通过
不经意
［③ｈ］
别
ʡ??
it'd
does
朝
it
‘
凭借
φ．
又及
抽冷子
?ʹ
替代
［④ｂ］
another
ʵ?
哪样
对
certain
you'd
／
要么
ά??
凡是
后来
however
－
不满
精光
诚如
前者
取道
????˵
大约
向着
rather
逐步
no
不特
thank
˭֪
不仅仅是
暗地里
常言道
它们
全都
由
follows
??ͬ
当中
????ʱ
喏
here
??????
他人
ȡ??
upon
by
只当
惯常
serious
off
宁肯
ʲ??
ͻ??
that's
～±
֮ǰ
>
之前
倍加
尽然
此地
论说
到底
am
呜
岂止
谁知
［①④］
anyhow
obviously
shall
虽说
reasonably
que
?µ?
take
5
why
一下
自从
could
一个
having
不消
［②ｊ］
一一
分期分批
使
设使
彻夜
consider
立时
总之
此后
regards
其余
敢于
②ｃ
.一
从重
seemed
恍然
various
［⑤］］
几
哉
先不先
’
别管
hasn't
（
downwards
近来
⑦
˫??
than
don't
所以
especially
??һ
此中
举凡
?ȷ?
另方面
although
并非
让
［①ｉ］
自个儿
另行
了
不会
［②⑥］
———
going
?ֱ?
姑且
此外
''
就是了
啊哈
gets
therefore
cause
可
φ
非特
或
究竟
also
这样
theres
或许
ƾ
in
自
you'll
那般
诸
末##末
enough
＜＜
?ô??
һЩ
...................
nor
ι
????֮
照着
somebody
尽早
不必
i'll
［②Ｇ］
［①ｆ］
如此等等
每
其次
不但
此次
∪φ∈
其中
thorough
took
placed
each
至于
大体上
挨门挨户
if
只
针对
而
?һ
furthermore
大略
遵照
［②ｆ］
me
hello
are
局外
they
was
where
只有
hereupon
用来
thats
经常
啪达
our
它是
［⑦］
right
任何
entirely
乌乎
哪天
己
＜Δ
??
挨家挨户
哗啦
ｂ］
一番
［①ａ］
Ϊʲ??
?δ?
kept
example
～＋
率尔
came
such
否则
where's
very
Ҫ??Ȼ
seem
由是
considering
哩
那儿
hardly
我们
i'm
不独
＜±
不力
换句话说
恰恰相反
thereby
不迭
doesn't
those
??λ
latterly
both
从古至今
那样
其一
乘
而论
不止一次
矣乎
极端
日益
刚巧
故此
现在
却
??Ҫ
那么
兼之
必须
总的来看
://
wherein
接下来
竟然
顷刻
至今
非但
tried
全部
”，
below
hither
继而
论
贼死
打开天窗说亮话
来说
…………………………………………………③
thru
顶多
呼啦
others
怎么
4
ת?
?޴?
充其量
除却
叮咚
亲身
赖以
(
sure
knows
per
?ǳ?
今天
immediate
难得
一则
better
不管怎样
不妨
＝－
got
由此
上去
俺们
地
不单
［⑤］
and
˵?
吓
??ӳ
?Ƚ?
那么样
often
断然
do
最
咚
罢了
＊
˳?
you're
反而
may
虽则
不止
Ŷ
分别
know
his
呆呆地
等到
meanwhile
themselves
至
也好
恰巧
is
彼时
outside
然而
seems
≈
动辄
得了
为
倘使
Ȼ??
刚才
her
最后
后
当然
ｃ］
［③ｂ］
难道
［②⑦］
即令
要不是
ǡǡ???
?Ӷ?
elsewhere
到
接着
至若
达旦
与其说
［①⑧］
[
afterwards
她
据
极其
at
look
&
?㷺
从无到有
〉
据称
mostly
［
也
appear
按
taken
多少
ͬʱ
haven't
able
?ͨ
һ
纵使
你们
诸位
或曰
?ν
about
要是
?λ
弹指之间
alone
该当
allow
嘿
谁
ever
nevertheless
［①ｃ］
背靠背
｛－
still
将要
是以
hi
然后
were
及
ʹ??
啥
above
currently
立地
merely
［②⑩］
云云
re
mean
已矣
照
向使
快要
somewhere
被
依照
为何
between
离
嗬
＜λ
except
［②ｂ］
'''


class TextHashChecker(object):
    def __init__(self, threshold=3, bit_block_size=16, host='localhost', port=6379, db=2, password="123456",
                 expire_time=60 * 1):
        self.threshold = threshold
        self.bit_block_size = bit_block_size
        self.redis = redis.StrictRedis(host=host, port=port, db=db, password=password)
        self.key_prefix = "ns:"
        self.stopword_list = [stopword.strip() for stopword in stopwords.split("\n")]
        self.expire_time = expire_time

    def calculate_hash(self, text: str) -> int:
        text = re.sub(r"[%s\n]+" % zhon.hanzi.punctuation, "", text)
        split_text = (item for item in jieba.cut(text) if
                      ((item not in self.stopword_list) and (item != '') and ('%' not in item) and (item.isalnum())))
        return Simhash(split_text).value

    @staticmethod
    def hamming_distance(x: int, y: int):
        return len(list(filter(lambda _n: _n == "1", f"{x ^ y:064b}")))

    def save_split_hash(self, raw_hash: int):
        bit64 = f"{raw_hash:064b}"
        split_bit = [bit64[i:i + self.bit_block_size] for i in range(0, 64, self.bit_block_size)]
        for b in split_bit:
            self.redis.sadd(f"{self.key_prefix}{b}", raw_hash)
            self.redis.expire(f"{self.key_prefix}{b}", self.expire_time)

    def cal_rds_hash(self, raw_hash: int):
        bit64 = f"{raw_hash:064b}"
        split_bit = [bit64[i:i + self.bit_block_size] for i in range(0, 64, self.bit_block_size)]
        _hamming_distance = {self.threshold + 1}
        hash_all = set()
        for b in split_bit:
            rds_hash = self.redis.smembers(f"{self.key_prefix}{b}")
            if not rds_hash:
                continue
            for _hash in rds_hash:
                hash_all.add(_hash)
        for _hash in hash_all:
            _hamming_distance.add(self.hamming_distance(raw_hash, int(_hash)))
        return min(_hamming_distance)

    def is_text_duplicated(self, text: str, mode: int = 1):
        """

        :param text:
        :param mode: 0：全不入，1：全入，2：只入不重复的
        :return:
        """
        is_duplicated = False
        if self.cal_rds_hash(self.calculate_hash(text)) <= self.threshold:
            is_duplicated = True

        if mode == 0:
            return is_duplicated
        elif mode == 1:
            self.save_split_hash(self.calculate_hash(text))
            return is_duplicated
        elif mode == 2:
            if not is_duplicated:
                self.save_split_hash(self.calculate_hash(text))
            return is_duplicated


if __name__ == '__main__':
    thc = TextHashChecker(threshold=3, bit_block_size=16, host='47.93.234.57', port=6379, db=5, password="123456")
    t = '''
    央行1111月18日发布的公告显示，当日开展1800亿元逆回购操作，期限为7天，中标利率为2.5%，较此前下调5个基点。业内人士认为，这是央行在本月初下调MLF操作利率以来，开展的又一项超出一些市场人士预期的货币政策操作。数据显示，此前1年期MLF利率下调是2016年6月以来首次，此次7天期央行逆回购利率下调则是2015年10月以来首次。
    '''
    print(thc.is_text_duplicated(t))
